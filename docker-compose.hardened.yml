# Hardened Docker Compose for Secure OpenClaw
# Upgraded with VISAclaw security features
#
# Security improvements:
# - Default-deny seccomp profile (blocks ptrace, mount, unshare, bpf, etc.)
# - All capabilities dropped
# - Read-only filesystem with limited tmpfs
# - Resource limits (CPU, memory, PIDs)
# - Non-root user
#
# Note: Docker sandbox mode is disabled (requires docker CLI in container)
# Container-level hardening provides security instead.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.hardened.yml up -d

services:
  openclaw-gateway:
    # ============================================
    # ENVIRONMENT - API Keys
    # ============================================
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENCLAW_MODEL: "claude-opus-4-5-20251101"
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      NODE_OPTIONS: "--max-old-space-size=1536"
      # GitHub token for agent to push code (optional)
      GH_TOKEN: ${GH_TOKEN:-}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      # Git configuration via environment (required for read-only filesystem)
      GIT_AUTHOR_NAME: ${GIT_AUTHOR_NAME:-OpenClaw}
      GIT_AUTHOR_EMAIL: ${GIT_AUTHOR_EMAIL:-openclaw@users.noreply.github.com}
      GIT_COMMITTER_NAME: ${GIT_COMMITTER_NAME:-OpenClaw}
      GIT_COMMITTER_EMAIL: ${GIT_COMMITTER_EMAIL:-openclaw@users.noreply.github.com}

    # ============================================
    # RESOURCE LIMITS - Prevent DoS
    # ============================================
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2048M
          pids: 256
        reservations:
          cpus: '0.25'
          memory: 128M

    # ============================================
    # SECURITY OPTIONS - Default-deny seccomp
    # ============================================
    security_opt:
      - no-new-privileges:true
      # CRITICAL: Use actual seccomp profile, NOT unconfined!
      # seccomp:unconfined disables kernel-level syscall filtering
      - seccomp=config/seccomp-profile.json

    # ============================================
    # CAPABILITY RESTRICTIONS
    # ============================================
    cap_drop:
      - ALL

    # ============================================
    # USER ISOLATION
    # ============================================
    user: "1000:1000"

    # ============================================
    # FILESYSTEM RESTRICTIONS
    # ============================================
    read_only: true
    tmpfs:
      - /tmp:size=128M,nosuid,nodev
      - /home/node/.npm:size=64M
      - /home/node/.config/git:size=4M

    # ============================================
    # ADDITIONAL HARDENING
    # ============================================
    privileged: false

  # ============================================
  # CLI SERVICE - Same hardening
  # ============================================
  openclaw-cli:
    security_opt:
      - no-new-privileges:true
      - seccomp=config/seccomp-profile.json
    cap_drop:
      - ALL
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp:size=64M,noexec,nosuid,nodev
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
          pids: 64
